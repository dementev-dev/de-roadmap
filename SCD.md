# –ú–µ–¥–ª–µ–Ω–Ω–æ –º–µ–Ω—è—é—â–∏–µ—Å—è –∏–∑–º–µ—Ä–µ–Ω–∏—è (SCD): –∫–∞–∫ —Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –≤ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –±–∞–∑–∞—Ö –¥–∞–Ω–Ω—ã—Ö

> **–î–ª—è –∫–æ–≥–æ —ç—Ç–∞ —Å—Ç–∞—Ç—å—è?**  
> –î–ª—è —Ç–µ—Ö, –∫—Ç–æ —É–∂–µ —É–º–µ–µ—Ç –ø–∏—Å–∞—Ç—å –±–∞–∑–æ–≤—ã–µ SQL-–∑–∞–ø—Ä–æ—Å—ã –≤ PostgreSQL, –∑–Ω–∞–∫–æ–º —Å –ø–æ–Ω—è—Ç–∏—è–º–∏ —Ç–∞–±–ª–∏—Ü, —Å—Ç—Ä–æ–∫ –∏ –∫–æ–ª–æ–Ω–æ–∫, –∏ —Ç–µ–ø–µ—Ä—å –¥–µ–ª–∞–µ—Ç –ø–µ—Ä–≤—ã–µ —à–∞–≥–∏ –≤ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ –∏ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â –¥–∞–Ω–Ω—ã—Ö.

---

## 1. –í–≤–µ–¥–µ–Ω–∏–µ: –∑–∞—á–µ–º –≤–æ–æ–±—â–µ –Ω—É–∂–Ω—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è –∏ –ø–æ—á–µ–º—É –æ–Ω–∏ ¬´–º–µ–¥–ª–µ–Ω–Ω–æ –º–µ–Ω—è—é—Ç—Å—è¬ª?

–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ, —á—Ç–æ –≤—ã —Å—Ç—Ä–æ–∏—Ç–µ –æ—Ç—á—ë—Ç –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º. –£ –≤–∞—Å –µ—Å—Ç—å —Ç–∞–±–ª–∏—Ü–∞ —Å —Ñ–∞–∫—Ç–∞–º–∏ ‚Äî –Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´–ø—Ä–æ–¥–∞–Ω–æ 10 –µ–¥–∏–Ω–∏—Ü —Ç–æ–≤–∞—Ä–∞ X –∫–ª–∏–µ–Ω—Ç—É Y 15 –º–∞—Ä—Ç–∞¬ª. –ù–æ —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å, *–∫—Ç–æ —Ç–∞–∫–æ–π –∫–ª–∏–µ–Ω—Ç Y* –∏–ª–∏ *—á—Ç–æ –∑–∞ —Ç–æ–≤–∞—Ä X*, –≤–∞–º –Ω—É–∂–Ω—ã **—Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏** ‚Äî —Ç–∞–±–ª–∏—Ü—ã —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –∫–ª–∏–µ–Ω—Ç–æ–≤, —Ç–æ–≤–∞—Ä–æ–≤, —Ä–µ–≥–∏–æ–Ω–æ–≤ –∏ —Ç.–ø.

–í –º–∏—Ä–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —Ç–∞–∫–∏–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ –Ω–∞–∑—ã–≤–∞—é—Ç **–∏–∑–º–µ—Ä–µ–Ω–∏—è–º–∏** (*dimensions*), –∞ —Ç–∞–±–ª–∏—Ü—É —Å –ø—Ä–æ–¥–∞–∂–∞–º–∏ ‚Äî **—Ñ–∞–∫—Ç–∞–º–∏** (*facts*).

–ê —Ç–µ–ø–µ—Ä—å –ø—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ: –∫–ª–∏–µ–Ω—Ç —Å–º–µ–Ω–∏–ª –∞–¥—Ä–µ—Å –∏–ª–∏ –ø–µ—Ä–µ—à—ë–ª –≤ –¥—Ä—É–≥—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑ ¬´–æ–±—ã—á–Ω–æ–≥–æ¬ª –≤ ¬´VIP¬ª). –ï—Å–ª–∏ –≤—ã –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü–µ –∫–ª–∏–µ–Ω—Ç–æ–≤, —Ç–æ –ø–æ—Ç–µ—Ä—è–µ—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–º, **–∫–∞–∫–æ–π —Å—Ç–∞—Ç—É—Å —É –∫–ª–∏–µ–Ω—Ç–∞ –±—ã–ª –Ω–∞ –º–æ–º–µ–Ω—Ç –ø—Ä–æ–¥–∞–∂–∏**. –ê —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ: –æ—Ç—á—ë—Ç ¬´–ø—Ä–æ–¥–∞–∂–∏ VIP-–∫–ª–∏–µ–Ω—Ç–∞–º –≤ –º–∞—Ä—Ç–µ¬ª –æ–∫–∞–∂–µ—Ç—Å—è –Ω–µ–≤–µ—Ä–Ω—ã–º!

–¢–∞–∫–∏–µ –∞—Ç—Ä–∏–±—É—Ç—ã ‚Äî –∫–æ—Ç–æ—Ä—ã–µ **–º–µ–Ω—è—é—Ç—Å—è —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º, –Ω–æ –Ω–µ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å** ‚Äî –∏ –Ω–∞–∑—ã–≤–∞—é—Ç—Å—è **–º–µ–¥–ª–µ–Ω–Ω–æ –º–µ–Ω—è—é—â–∏–º–∏—Å—è –∏–∑–º–µ—Ä–µ–Ω–∏—è–º–∏** (*Slowly Changing Dimensions*, **SCD**).

---

## 2. –ß—Ç–æ —Ç–∞–∫–æ–µ Slowly Changing Dimensions (SCD)?

SCD ‚Äî —ç—Ç–æ –ø–æ–¥—Ö–æ–¥ –∫ —Ö—Ä–∞–Ω–µ–Ω–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∏–∑–º–µ—Ä–µ–Ω–∏—è—Ö **—Å —É—á—ë—Ç–æ–º –≤—Ä–µ–º–µ–Ω–∏**. –û–Ω –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –≤—Ä–æ–¥–µ:

- –ö–∞–∫–æ–π –∞–¥—Ä–µ—Å —É –∫–ª–∏–µ–Ω—Ç–∞ –±—ã–ª **–Ω–∞ –¥–∞—Ç—É –∑–∞–∫–∞–∑–∞**?
- –°–∫–æ–ª—å–∫–æ –ø—Ä–æ–¥–∞–∂ –ø—Ä–∏—à–ª–æ—Å—å –Ω–∞ —Ç–æ–≤–∞—Ä—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ¬´–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞¬ª **–¥–æ —Ç–æ–≥–æ, –∫–∞–∫ –µ—ë –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–ª–∏ –≤ ¬´–ì–∞–¥–∂–µ—Ç—ã¬ª**?

–ë–µ–∑ SCD –≤—ã –≤–∏–¥–∏—Ç–µ —Ç–æ–ª—å–∫–æ **—Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ**, –∞ —Å –Ω–∏–º ‚Äî **–≤—Å—é –∏—Å—Ç–æ—Ä–∏—é**.

---

## 3. –¢–∏–ø—ã SCD ‚Äî –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏

–°—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π. –†–∞—Å—Å–º–æ—Ç—Ä–∏–º —Å–∞–º—ã–µ –≤–∞–∂–Ω—ã–µ.

### **Type 0 ‚Äî –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è**
–ê—Ç—Ä–∏–±—É—Ç —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω –Ω–∞–≤—Å–µ–≥–¥–∞. –ù–∞–ø—Ä–∏–º–µ—Ä, –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞.  
–¢–∞–∫–∏–µ –ø–æ–ª—è –Ω–µ —Ç—Ä–µ–±—É—é—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ ‚Äî –æ–Ω–∏ –ø—Ä–æ—Å—Ç–æ –Ω–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è.

### **Type 1 ‚Äî –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å**
–í—ã –ø—Ä–æ—Å—Ç–æ –¥–µ–ª–∞–µ—Ç–µ `UPDATE`, –∏ —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏—Å—á–µ–∑–∞–µ—Ç.

‚úÖ –ü—Ä–æ—Å—Ç–æ.  
‚ùå –ò—Å—Ç–æ—Ä–∏—è —Ç–µ—Ä—è–µ—Ç—Å—è.

> –ü–æ–¥—Ö–æ–¥–∏—Ç, –µ—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ ‚Äî —ç—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ–ø–µ—á–∞—Ç–∫–∞ –≤ –∏–º–µ–Ω–∏).

### **Type 2 ‚Äî –ù–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏**
–ö–∞–∂–¥–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ—Ä–æ–∂–¥–∞–µ—Ç **–Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É** –≤ —Ç–∞–±–ª–∏—Ü–µ. –°—Ç–∞—Ä–∞—è —Å—Ç—Ä–æ–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è, –Ω–æ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ ¬´—É—Å—Ç–∞—Ä–µ–≤—à–∞—è¬ª.

‚úÖ –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è.  
‚úÖ –ú–æ–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–∞ –ª—é–±—É—é –¥–∞—Ç—É.  
‚ùå –ë–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö, —Å–ª–æ–∂–Ω–µ–µ –∑–∞–ø—Ä–æ—Å—ã.

> –≠—Ç–æ **—Å–∞–º—ã–π —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—ë–Ω–Ω—ã–π** –ø–æ–¥—Ö–æ–¥ –≤ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ.

### **Type 3 ‚Äî –î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É ¬´–ø—Ä–µ–¥—ã–¥—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ¬ª**
–í —Ç–∞–±–ª–∏—Ü–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è –ø–æ–ª—è –≤—Ä–æ–¥–µ `previous_category`, `category_change_date`.

‚úÖ –ü—Ä–æ—Å—Ç–∞—è –∏—Å—Ç–æ—Ä–∏—è ¬´–¥–æ/–ø–æ—Å–ª–µ¬ª.  
‚ùå –•—Ä–∞–Ω–∏—Ç —Ç–æ–ª—å–∫–æ **–æ–¥–Ω–æ** –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ. –ù–µ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è.

> –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–µ–¥–∫–æ, —á–∞—â–µ –∫–∞–∫ –∫–æ–º–ø—Ä–æ–º–∏—Å—Å –≤ –æ—á–µ–Ω—å –ø—Ä–æ—Å—Ç—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö.

### **Type 4, 5, 6 ‚Äî –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –≥–∏–±—Ä–∏–¥—ã**
–≠—Ç–∏ —Ç–∏–ø—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç, –Ω–æ **–≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è —Ä–µ–¥–∫–æ** –∏ –ø–æ—á—Ç–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –Ω–æ–≤–∏—á–∫–∞–º–∏:

- **Type 4**: –∏—Å—Ç–æ—Ä–∏—è –≤—ã–Ω–æ—Å–∏—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É (¬´–º–∏–Ω–∏-—Ö—Ä–∞–Ω–∏–ª–∏—â–µ¬ª –¥–ª—è –æ–¥–Ω–æ–≥–æ –∏–∑–º–µ—Ä–µ–Ω–∏—è).
- **Type 5**: –∫–æ–º–±–∏–Ω–∞—Ü–∏—è Type 4 –∏ Type 1 ‚Äî —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ, –∞ –∏—Å—Ç–æ—Ä–∏—è ‚Äî –æ—Ç–¥–µ–ª—å–Ω–æ.
- **Type 6**: –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç Type 1, 2 –∏ 3 –≤ –æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ ‚Äî –æ—á–µ–Ω—å –≥–∏–±–∫–æ, –Ω–æ —Å–ª–æ–∂–Ω–æ.

> –í–∞–º **–Ω–µ –Ω—É–∂–Ω–æ –∑–∞–ø–æ–º–∏–Ω–∞—Ç—å** —ç—Ç–∏ —Ç–∏–ø—ã —Å–µ–π—á–∞—Å. –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–Ω–∞—Ç—å, —á—Ç–æ –æ–Ω–∏ –±—ã–≤–∞—é—Ç ‚Äî –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –≤—Å—Ç—Ä–µ—Ç–∏—Ç–µ –∏—Ö –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏.

---

## 4. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä –Ω–∞ PostgreSQL: Type 1 vs Type 2

–î–æ–ø—É—Å—Ç–∏–º, —É –Ω–∞—Å –µ—Å—Ç—å —Ç–∞–±–ª–∏—Ü–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤:

```sql
-- –ò—Å—Ö–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ (–¥–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
CREATE TABLE customers (
    customer_id SERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    category TEXT NOT NULL  -- –Ω–∞–ø—Ä–∏–º–µ—Ä: 'Regular', 'VIP'
);
```

### Type 1: –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º

–ö–ª–∏–µ–Ω—Ç ‚Ññ1 —Å—Ç–∞–ª VIP:

```sql
UPDATE customers
SET category = 'VIP'
WHERE customer_id = 1;
```

–¢–µ–ø–µ—Ä—å –≤ —Ç–∞–±–ª–∏—Ü–µ —Ç–æ–ª—å–∫–æ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ. –ï—Å–ª–∏ –ø—Ä–æ–¥–∞–∂–∞ –±—ã–ª–∞ —Å–¥–µ–ª–∞–Ω–∞ **–¥–æ** —ç—Ç–æ–≥–æ UPDATE, –≤—ã –Ω–µ —É–∑–Ω–∞–µ—Ç–µ, —á—Ç–æ –∫–ª–∏–µ–Ω—Ç —Ç–æ–≥–¥–∞ –±—ã–ª ¬´Regular¬ª.

---

### Type 2: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é ‚Äî –ø–æ–¥—Ä–æ–±–Ω–µ–µ

–ß—Ç–æ–±—ã —Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é, –º—ã –º–µ–Ω—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã. –í–æ—Ç –∫–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è:

- **`customer_key`** ‚Äî –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π (surrogate) –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á. –û–Ω **—É–Ω–∏–∫–∞–ª–µ–Ω –¥–ª—è –∫–∞–∂–¥–æ–π –≤–µ—Ä—Å–∏–∏** –∫–ª–∏–µ–Ω—Ç–∞.
- **`customer_id`** ‚Äî –±–∏–∑–Ω–µ—Å-–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑ CRM). –û–Ω **–Ω–µ –º–µ–Ω—è–µ—Ç—Å—è** –∏ —Å–≤—è–∑—ã–≤–∞–µ—Ç –≤—Å–µ –≤–µ—Ä—Å–∏–∏ –æ–¥–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞.
- **`valid_from`** ‚Äî –¥–∞—Ç–∞, **—Å –∫–æ—Ç–æ—Ä–æ–π** —ç—Ç–∞ –≤–µ—Ä—Å–∏—è —Å—Ç–∞–ª–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π.
- **`valid_to`** ‚Äî –¥–∞—Ç–∞, **–ø–æ –∫–æ—Ç–æ—Ä—É—é** —ç—Ç–∞ –≤–µ—Ä—Å–∏—è –±—ã–ª–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π. –ï—Å–ª–∏ `NULL` ‚Äî –∑–Ω–∞—á–∏—Ç, –≤–µ—Ä—Å–∏—è **–∞–∫—Ç—É–∞–ª—å–Ω–∞ —Å–µ–π—á–∞—Å**.
- **`is_current`** ‚Äî —Ñ–ª–∞–≥ (`true`/`false`), –∫–æ—Ç–æ—Ä—ã–π –±—ã—Å—Ç—Ä–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫–∞—è —Å—Ç—Ä–æ–∫–∞ ‚Äî –ø–æ—Å–ª–µ–¥–Ω—è—è. –£–¥–æ–±–µ–Ω –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤.

–ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:

```sql
CREATE TABLE customers_scd2 (
    customer_key SERIAL PRIMARY KEY,     -- —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∫–∞–∂–¥–æ–π –≤–µ—Ä—Å–∏–∏
    customer_id INT NOT NULL,            -- –Ω–µ–∏–∑–º–µ–Ω–Ω—ã–π –±–∏–∑–Ω–µ—Å-ID –∫–ª–∏–µ–Ω—Ç–∞
    name TEXT NOT NULL,
    category TEXT NOT NULL,
    valid_from DATE NOT NULL,            -- —Å –∫–∞–∫–æ–π –¥–∞—Ç—ã –¥–µ–π—Å—Ç–≤—É–µ—Ç
    valid_to DATE,                       -- –ø–æ –∫–∞–∫—É—é –¥–∞—Ç—É –¥–µ–π—Å—Ç–≤–æ–≤–∞–ª–∞ (NULL = —Å–µ–π—á–∞—Å)
    is_current BOOLEAN NOT NULL          -- true = –∞–∫—Ç—É–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è
);
```

**–®–∞–≥ 1.** –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é –∑–∞–ø–∏—Å—å (–∫–ª–∏–µ–Ω—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª—Å—è 1 —è–Ω–≤–∞—Ä—è 2024):

```sql
INSERT INTO customers_scd2 (customer_id, name, category, valid_from, valid_to, is_current)
VALUES (1, '–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤', 'Regular', '2024-01-01', NULL, true);
```

**–®–∞–≥ 2.** 15 –∞–ø—Ä–µ–ª—è 2025 –∫–ª–∏–µ–Ω—Ç —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è VIP. –ú—ã –¥–µ–ª–∞–µ–º **–¥–≤–∞ –¥–µ–π—Å—Ç–≤–∏—è**:

1. **–ó–∞–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä—É—é –∑–∞–ø–∏—Å—å**: —É–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –æ–Ω–∞ –±—ã–ª–∞ –∞–∫—Ç—É–∞–ª—å–Ω–∞ **–¥–æ 14 –∞–ø—Ä–µ–ª—è**.
2. **–î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å**: –æ–Ω–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å **—Å 15 –∞–ø—Ä–µ–ª—è** –∏ –ø–æ–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω–∞.

```sql
-- 1. –ó–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –≤–µ—Ä—Å–∏—é
UPDATE customers_scd2
SET valid_to = '2025-04-14',
    is_current = false
WHERE customer_id = 1 AND is_current = true;

-- 2. –í—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é
INSERT INTO customers_scd2 (customer_id, name, category, valid_from, valid_to, is_current)
VALUES (1, '–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤', 'VIP', '2025-04-15', NULL, true);
```

–¢–µ–ø–µ—Ä—å –≤ —Ç–∞–±–ª–∏—Ü–µ –¥–≤–µ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞. –ò –º—ã –º–æ–∂–µ–º —Å–ø—Ä–æ—Å–∏—Ç—å:

> –ö–∞–∫–æ–π –±—ã–ª–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –∫–ª–∏–µ–Ω—Ç–∞ **–Ω–∞ 10 –∞–ø—Ä–µ–ª—è 2025**?

```sql
SELECT category
FROM customers_scd2
WHERE customer_id = 1
  AND '2025-04-10' >= valid_from
  AND '2025-04-10' <= COALESCE(valid_to, '9999-12-31');
```

–†–µ–∑—É–ª—å—Ç–∞—Ç: `'Regular'` ‚Äî –ø—Ä–∞–≤–∏–ª—å–Ω–æ!

> üí° –ü–æ—á–µ–º—É `COALESCE(valid_to, '9999-12-31')`?  
> –ü–æ—Ç–æ–º—É —á—Ç–æ —É –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∑–∞–ø–∏—Å–∏ `valid_to IS NULL`. –ß—Ç–æ–±—ã —É—Å–ª–æ–≤–∏–µ —Ä–∞–±–æ—Ç–∞–ª–æ, –º—ã –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–º–µ–Ω—è–µ–º `NULL` –Ω–∞ –æ—á–µ–Ω—å –¥–∞–ª—ë–∫—É—é –¥–∞—Ç—É.

---

### Type 2: –º–æ–∂–Ω–æ –ª–∏ –æ–±–æ–π—Ç–∏—Å—å –±–µ–∑ `is_current`?

–ü–æ–ª–µ `is_current` **–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ**. –û–Ω–æ —É–¥–æ–±–Ω–æ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `WHERE is_current = true`), –Ω–æ **–≤—Å—é —Ç—É –∂–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –Ω–µ—Å—ë—Ç –ø–∞—Ä–∞ `valid_from` / `valid_to`**.

–ú–Ω–æ–≥–∏–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ SCD Type 2 –æ–±—Ö–æ–¥—è—Ç—Å—è –±–µ–∑ —ç—Ç–æ–≥–æ —Ñ–ª–∞–≥–∞ ‚Äî –æ—Å–æ–±–µ–Ω–Ω–æ –≤ —Å–∏—Å—Ç–µ–º–∞—Ö, –≥–¥–µ –≤–∞–∂–Ω–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∏–ª–∏ –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –∏–∑–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏. –í —Ç–∞–∫–∏—Ö —Å–ª—É—á–∞—è—Ö –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç –ø–æ —É—Å–ª–æ–≤–∏—é:

```sql
WHERE valid_to IS NULL
```

–ò–ª–∏, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ¬´–∑–∞–∫—Ä—ã—Ç—ã–π¬ª –∏–Ω—Ç–µ—Ä–≤–∞–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, `valid_to = '2025-04-14'` –¥–ª—è –ø—Ä–æ—à–ª–æ–π –≤–µ—Ä—Å–∏–∏, –∞ —É –Ω–æ–≤–æ–π ‚Äî `valid_from = '2025-04-15'`, `valid_to = '9999-12-31'`), —Ç–æ:

```sql
WHERE CURRENT_DATE BETWEEN valid_from AND valid_to
```

–¢–∞–∫ —á—Ç–æ `is_current` ‚Äî —ç—Ç–æ **–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —É–ø—Ä–æ—â–µ–Ω–∏–µ**, –∞ –Ω–µ —á–∞—Å—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞.

---

### Type 2 —á–µ—Ä–µ–∑ –ª–æ–≥–∏–∫—É, –ø–æ—Ö–æ–∂—É—é –Ω–∞ UPSERT

–í —Ä–µ–∞–ª—å–Ω—ã—Ö ETL-–ø—Ä–æ—Ü–µ—Å—Å–∞—Ö —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç **–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–µ** –æ–ø–µ—Ä–∞—Ü–∏–∏: –∑–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ –¥–≤–∞–∂–¥—ã –Ω–µ –¥–æ–ª–∂–µ–Ω –ª–æ–º–∞—Ç—å –¥–∞–Ω–Ω—ã–µ. –î–ª—è —ç—Ç–æ–≥–æ —É–¥–æ–±–Ω–æ –ø—Ä–∏–º–µ–Ω—è—Ç—å –ø–æ–¥—Ö–æ–¥, –ø–æ—Ö–æ–∂–∏–π –Ω–∞ *upsert* (update + insert), –Ω–æ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥ –ª–æ–≥–∏–∫—É SCD Type 2.

–í PostgreSQL –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π `ON CONFLICT` –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –Ω–∞–ø—Ä—è–º—É—é, –ø–æ—Ç–æ–º—É —á—Ç–æ –º—ã **–Ω–µ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å—Ç—Ä–æ–∫—É**, –∞ **–¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏**.

–ü–æ—ç—Ç–æ–º—É –ª–æ–≥–∏–∫–∞ –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫:

1. –°—Ä–∞–≤–Ω–∏—Ç—å –≤—Ö–æ–¥—è—â–∏–µ –¥–∞–Ω–Ω—ã–µ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ.
2. –ï—Å–ª–∏ –∞—Ç—Ä–∏–±—É—Ç—ã –∏–∑–º–µ–Ω–∏–ª–∏—Å—å ‚Äî –∑–∞–∫—Ä—ã—Ç—å —Å—Ç–∞—Ä—É—é –∑–∞–ø–∏—Å—å –∏ –≤—Å—Ç–∞–≤–∏—Ç—å –Ω–æ–≤—É—é.
3. –ï—Å–ª–∏ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞—Ç—å.

–ü—Ä–∏–º–µ—Ä (—á–∞—Å—Ç–æ —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è –≤ Python, dbt, Airflow –∏ —Ç.–ø.):

```sql
-- –ü—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è: customer_id=1, category='VIP', effective_date='2025-04-15'

-- –®–∞–≥ 1: –≤—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
WITH last_version AS (
  SELECT * FROM customers_scd2
  WHERE customer_id = 1 AND is_current = true
)
INSERT INTO customers_scd2 (customer_id, name, category, valid_from, valid_to, is_current)
SELECT 1, '–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤', 'VIP', '2025-04-15', NULL, true
WHERE EXISTS (
  SELECT 1 FROM last_version WHERE category != 'VIP'
);

-- –®–∞–≥ 2: –µ—Å–ª–∏ –≤—Å—Ç–∞–≤–∫–∞ –ø—Ä–æ–∏–∑–æ—à–ª–∞ ‚Äî –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä—É—é –∑–∞–ø–∏—Å—å
UPDATE customers_scd2
SET valid_to = '2025-04-14', is_current = false
WHERE customer_id = 1 AND is_current = true
  AND EXISTS (
    SELECT 1 FROM customers_scd2
    WHERE customer_id = 1 AND category = 'VIP' AND valid_from = '2025-04-15'
  );
```

–ù–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ —Ç–∞–∫–∏–µ –ª–æ–≥–∏–∫–∏ —á–∞—â–µ –≤—ã–Ω–æ—Å—è—Ç –≤ **ETL-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã** (–Ω–∞–ø—Ä–∏–º–µ—Ä, dbt —Å –ø–∞–∫–µ—Ç–æ–º `dbt-scd`), –ø–æ—Ç–æ–º—É —á—Ç–æ —á–∏—Å—Ç—ã–π SQL –±—ã—Å—Ç—Ä–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –≥—Ä–æ–º–æ–∑–¥–∫–∏–º.

> üí° –ì–ª–∞–≤–Ω–æ–µ: **SCD Type 2 ‚Äî —ç—Ç–æ –Ω–µ –æ–¥–Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏—è, –∞ –ø—Ä–æ—Ü–µ—Å—Å**: —Å—Ä–∞–≤–Ω–∏—Ç—å ‚Üí –∑–∞–∫—Ä—ã—Ç—å —Å—Ç–∞—Ä–æ–µ ‚Üí –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ.

---

### –ê —á—Ç–æ, –µ—Å–ª–∏ –°–£–ë–î –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç UPDATE? (Trino, Hive, ClickHouse –≤ —Ä–µ–∂–∏–º–µ append-only)

–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–∏—Å—Ç–µ–º—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, **Hive –≤ —Ñ–æ—Ä–º–∞—Ç–µ ORC/Parquet**, **Trino**, **ClickHouse –≤ —Ä–µ–∂–∏–º–µ —Ç–æ–ª—å–∫–æ –≤—Å—Ç–∞–≤–∫–∏**) **–Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç UPDATE —Å—Ç–∞—Ä—ã—Ö —Å—Ç—Ä–æ–∫**. –ö–∞–∫ —Ç–æ–≥–¥–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å SCD Type 2?

–û—Ç–≤–µ—Ç: **–Ω–∏–∫–∞–∫–∏—Ö UPDATE –Ω–µ –Ω—É–∂–Ω–æ** ‚Äî –≤–µ–¥—å –≤ Type 2 –º—ã –∏ —Ç–∞–∫ **–Ω–µ –º–µ–Ω—è–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ**, –∞ —Ç–æ–ª—å–∫–æ **–¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ**!

–ê–ª–≥–æ—Ä–∏—Ç–º –∑–∞–≥—Ä—É–∑–∫–∏ (ETL):
1. –°—Ä–∞–≤–Ω–∏—Ç—å –≤—Ö–æ–¥—è—â–∏–µ –¥–∞–Ω–Ω—ã–µ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ.
2. –ï—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è ‚Äî **–ø–∏—à–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É** —Å –Ω–æ–≤—ã–º–∏ `valid_from` / `valid_to`.
3. –°—Ç–∞—Ä—ã–µ —Å—Ç—Ä–æ–∫–∏ –æ—Å—Ç–∞—é—Ç—Å—è –Ω–µ—Ç—Ä–æ–Ω—É—Ç—ã–º–∏.

–ü—Ä–∏–º–µ—Ä –≤ Trino/Hive-—Å—Ç–∏–ª–µ (—Ç–æ–ª—å–∫–æ INSERT):

```sql
-- new_customers ‚Äî staging-—Ç–∞–±–ª–∏—Ü–∞ —Å –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
-- dim_customers_scd2 ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ (append-only)

INSERT INTO dim_customers_scd2
WITH current_customers AS (
  SELECT *
  FROM (
    SELECT *, ROW_NUMBER() OVER (PARTITION BY customer_id ORDER BY valid_from DESC) AS rn
    FROM dim_customers_scd2
  ) 
  WHERE rn = 1  -- –æ—Ç–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—É—é, —Å–∞–º—É—é —Å–≤–µ–∂—É—é, –∑–∞–ø–∏—Å—å
)
SELECT
  uuid() AS customer_key,  -- —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∫–∞–∂–¥–æ–π –≤–µ—Ä—Å–∏–∏
  n.customer_id,           -- –Ω–µ–∏–∑–º–µ–Ω–Ω—ã–π –±–∏–∑–Ω–µ—Å-ID –∫–ª–∏–µ–Ω—Ç–∞
  n.name,
  n.category,
  valid_from
FROM new_customers n
LEFT JOIN current_customers c ON n.customer_id = c.customer_id
WHERE c.customer_id IS NULL OR c.category != n.category;  -- —É—Å–ª–æ–≤–∏–µ –≤–µ—Ä–Ω–æ, –µ—Å–ª–∏ –∫–∞–∫–∏–µ-—Ç–æ –∏–∑ –ø–æ–ª–µ–π —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ –ø–æ–º–µ–Ω—è–ª–∏—Å—å
```

**–ì–ª–∞–≤–Ω—ã–π –≤–æ–ø—Ä–æ—Å –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏: –∫–∞–∫ –∂–µ —á–∏—Ç–∞—Ç—å —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ?**

–ü–æ—Å–∫–æ–ª—å–∫—É –º—ã –Ω–µ –º–æ–∂–µ–º –æ–±–Ω–æ–≤–ª—è—Ç—å `valid_to` —É –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ (—É –Ω–µ—ë –æ—Å—Ç–∞–Ω–µ—Ç—Å—è `NULL`), —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–æ–¥—Ö–æ–¥ —Å `BETWEEN` –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç. –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ, –¥–ª—è –ø–æ–∏—Å–∫–∞ –Ω—É–∂–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –º—ã –ø–æ–ª–∞–≥–∞–µ–º—Å—è –Ω–∞ **–æ–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏** –∏–ª–∏ –Ω–∞ –ª–æ–≥–∏–∫—É ¬´–±–ª–∏–∂–∞–π—à–µ–π –¥–∞—Ç—ã, –Ω–æ –Ω–µ –ø–æ–∑–∂–µ¬ª.

#### –ü–∞—Ç—Ç–µ—Ä–Ω 1: –ù–∞–π—Ç–∏ –ø–æ—Å–ª–µ–¥–Ω—é—é (–∞–∫—Ç—É–∞–ª—å–Ω—É—é) –≤–µ—Ä—Å–∏—é –Ω–∞ —Å–µ–≥–æ–¥–Ω—è

–≠—Ç–æ —Å–∞–º—ã–π —á–∞—Å—Ç—ã–π –∑–∞–ø—Ä–æ—Å. –ú—ã —Ö–æ—Ç–∏–º –≤–∏–¥–µ—Ç—å —Å–∞–º—É—é —Å–≤–µ–∂—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª–∏–µ–Ω—Ç–µ.

```sql
-- –í–∞—Ä–∏–∞–Ω—Ç —Å –æ–∫–æ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–µ–π (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∏ –Ω–∞–¥–µ–∂–Ω—ã–π)
WITH ranked AS (
  SELECT 
    *, 
    ROW_NUMBER() OVER (PARTITION BY customer_id ORDER BY valid_from DESC) AS rn
  FROM customers_scd2
)
SELECT 
  customer_id, name, category, valid_from
FROM ranked 
WHERE rn = 1;
```

–≠—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å –±–µ—Ä—ë—Ç —Å—Ç—Ä–æ–∫—É —Å —Å–∞–º–æ–π –ø–æ–∑–¥–Ω–µ–π –¥–∞—Ç–æ–π –Ω–∞—á–∞–ª–∞ –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞.

#### –ü–∞—Ç—Ç–µ—Ä–Ω 2: –ù–∞–π—Ç–∏ –≤–µ—Ä—Å–∏—é, –∫–æ—Ç–æ—Ä–∞—è –±—ã–ª–∞ –∞–∫—Ç—É–∞–ª—å–Ω–∞ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –¥–∞—Ç—É

–≠—Ç–æ –æ—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å SCD2. –ù–∞–ø—Ä–∏–º–µ—Ä, ¬´–∫–∞–∫–æ–π —Å—Ç–∞—Ç—É—Å –∫–ª–∏–µ–Ω—Ç–∞ –±—ã–ª –Ω–∞ –¥–∞—Ç—É –∑–∞–∫–∞–∑–∞ `2025-03-15`?¬ª.

–í append-only –º–∏—Ä–µ —É –Ω–∞—Å –Ω–µ—Ç `valid_to`, –ø–æ—ç—Ç–æ–º—É –º—ã –∏—â–µ–º **–ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é, —É –∫–æ—Ç–æ—Ä–æ–π `valid_from` ‚â§ —Ü–µ–ª–µ–≤–æ–π –¥–∞—Ç—ã**.

```sql
-- –ó–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –Ω–∞ '2025-03-15'
WITH as_of_date AS (
  SELECT 
    *,
    ROW_NUMBER() OVER (PARTITION BY customer_id ORDER BY valid_from DESC) AS rn
  FROM customers_scd2
  WHERE valid_from <= DATE '2025-03-15'
)
SELECT 
  customer_id, name, category, valid_from
FROM as_of_date 
WHERE rn = 1;
```

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. `WHERE valid_from <= DATE '2025-03-15'` –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤—ã–≤–∞–µ—Ç –≤—Å–µ –≤–µ—Ä—Å–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ—è–≤–∏–ª–∏—Å—å **–ø–æ—Å–ª–µ** –Ω–∞—à–µ–π —Ü–µ–ª–µ–≤–æ–π –¥–∞—Ç—ã.
2. `ORDER BY valid_from DESC` —Å–æ—Ä—Ç–∏—Ä—É–µ—Ç –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –≤–µ—Ä—Å–∏–∏ –æ—Ç —Å–∞–º–æ–π —Å–≤–µ–∂–µ–π –∫ —Å–∞–º–æ–π —Å—Ç–∞—Ä–æ–π.
3. `ROW_NUMBER() ... WHERE rn = 1` –≤—ã–±–∏—Ä–∞–µ—Ç —Å–∞–º—É—é —Å–≤–µ–∂—É—é –∏–∑ **–∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –Ω–∞ —Ç—É –¥–∞—Ç—É** –≤–µ—Ä—Å–∏–π.

–≠—Ç–æ –∏ –µ—Å—Ç—å ¬´–ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ –≤–æ –≤—Ä–µ–º–µ–Ω–∏¬ª (time travel) –≤ —Å–∏—Å—Ç–µ–º–∞—Ö –±–µ–∑ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏.

> **–ü–æ—á–µ–º—É –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `is_current`?**  
> –í append-only —Å–∏—Å—Ç–µ–º–∞—Ö —Ñ–ª–∞–≥ `is_current` —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —É—Å—Ç–∞—Ä–µ–≤—à–∏–º —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –Ω–æ–≤–æ–π –≤—Å—Ç–∞–≤–∫–∏. –ï–≥–æ –æ—á–µ–Ω—å —Å–ª–æ–∂–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –±–µ–∑ `UPDATE`, –ø–æ—ç—Ç–æ–º—É –≤ —Ç–∞–∫–∏—Ö –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞—Ö –µ–≥–æ —á–∞—â–µ **–Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç**, –ø–æ–ª–∞–≥–∞—è—Å—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞ –¥–∞—Ç—ã –∏ –æ–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏. –≠—Ç–æ –¥–µ–ª–∞–µ—Ç –º–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö –±–æ–ª–µ–µ —á–∏—Å—Ç–æ–π –∏ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ–π.

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, SCD Type 2 –Ω–µ —Ç–æ–ª—å–∫–æ —Å–æ–≤–º–µ—Å—Ç–∏–º —Å append-only —Å–∏—Å—Ç–µ–º–∞–º–∏, –Ω–æ –∏ —è–≤–ª—è–µ—Ç—Å—è –¥–ª—è –Ω–∏—Ö **–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –≤—ã–±–æ—Ä–æ–º**, —Ç–∞–∫ –∫–∞–∫ –µ–≥–æ –ª–æ–≥–∏–∫–∞ –æ—Å–Ω–æ–≤–∞–Ω–∞ –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö, –∞ –Ω–µ –Ω–∞ –∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–∏.

---

## 5. –ö–æ–≥–¥–∞ —á—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å?

| –°—Ü–µ–Ω–∞—Ä–∏–π | –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ç–∏–ø |
|--------|------------------|
| –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–ø–µ—á–∞—Ç–∫–∏ | Type 1 |
| –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏ –∑–Ω–∞—á–∏–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (—Å—Ç–∞—Ç—É—Å, —Ç–∞—Ä–∏—Ñ, —Ä–µ–≥–∏–æ–Ω) | Type 2 |
| –û—á–µ–Ω—å –ø—Ä–æ—Å—Ç–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –±–µ–∑ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ –∏—Å—Ç–æ—Ä–∏–∏ | Type 1 |
| –ù—É–∂–Ω–∞ —Ç–æ–ª—å–∫–æ ¬´–ø–æ—Å–ª–µ–¥–Ω—è—è —Å–º–µ–Ω–∞¬ª –∏ –Ω–∏—á–µ–≥–æ –±–æ–ª—å—à–µ | Type 3 (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ!) |

**–°–æ–≤–µ—Ç –Ω–æ–≤–∏—á–∫—É**: –µ—Å–ª–∏ —Å–æ–º–Ω–µ–≤–∞–µ—Ç–µ—Å—å ‚Äî –≤—ã–±–∏—Ä–∞–π—Ç–µ **Type 2**. –õ—É—á—à–µ –∏–º–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ—ë, —á–µ–º –Ω–µ –∏–º–µ—Ç—å –∏ –Ω–µ —Å—É–º–µ—Ç—å –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–∞–∂–Ω—ã–π –≤–æ–ø—Ä–æ—Å.

---

## 6. –ü–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏ –∏ —Å–æ–≤–µ—Ç—ã

- **–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `customer_id` –∫–∞–∫ –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á –≤ Type 2**. –û–Ω –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è! –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ ‚Äî `customer_key` (surrogate key).
- –í—Å–µ–≥–¥–∞ –∑–∞–¥–∞–≤–∞–π—Ç–µ `valid_to` –∫–∞–∫ `NULL` –¥–ª—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∑–∞–ø–∏—Å–∏, –µ—Å–ª–∏ —ç—Ç–æ –¥–æ–ø—É—Å—Ç–∏–º–æ –≤ –≤–∞—à–µ–π –°–£–ë–î ‚Äî —ç—Ç–æ —É–ø—Ä–æ—â–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã.
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `COALESCE(valid_to, '9999-12-31')` –≤ —É—Å–ª–æ–≤–∏—è—Ö, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å `NULL`-–ø—Ä–æ–±–ª–µ–º.
- Type 2 —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –æ–±—ä—ë–º –¥–∞–Ω–Ω—ã—Ö ‚Äî –Ω–æ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ.
- –í —Å–≤—è–∑–∫–µ —Å —Ñ–∞–∫—Ç–∞–º–∏: –≤ —Ç–∞–±–ª–∏—Ü–µ —Ñ–∞–∫—Ç–æ–≤ —Ö—Ä–∞–Ω–∏—Ç–µ **`customer_key`**, –∞ –Ω–µ `customer_id` ‚Äî –∏–Ω–∞—á–µ –Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è —Å–æ–µ–¥–∏–Ω–∏—Ç—å —Å –Ω—É–∂–Ω–æ–π –≤–µ—Ä—Å–∏–µ–π.

---

## 7. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ú–µ–¥–ª–µ–Ω–Ω–æ –º–µ–Ω—è—é—â–∏–µ—Å—è –∏–∑–º–µ—Ä–µ–Ω–∏—è ‚Äî —ç—Ç–æ –Ω–µ ¬´–º–∞–≥–∏—è¬ª, –∞ **–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç** –¥–ª—è —á–µ—Å—Ç–Ω–æ–π –∏ —Ç–æ—á–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –≤–æ –≤—Ä–µ–º–µ–Ω–∏.

–ù–∞—á–Ω–∏—Ç–µ —Å –ø–æ–Ω–∏–º–∞–Ω–∏—è —Ä–∞–∑–Ω–∏—Ü—ã –º–µ–∂–¥—É Type 1 –∏ Type 2. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–±–∞ –ø–æ–¥—Ö–æ–¥–∞ –≤ —Å–≤–æ—ë–º PostgreSQL. –ó–∞–¥–∞–π—Ç–µ —Å–µ–±–µ –≤–æ–ø—Ä–æ—Å:  
> ¬´–ï—Å–ª–∏ –±—ã —è –ø–æ—Å—Ç—Ä–æ–∏–ª –æ—Ç—á—ë—Ç –ø–æ –¥–∞–Ω–Ω—ã–º –Ω–∞ –ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü ‚Äî –¥–∞–ª –±—ã –æ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ—Å–ª–µ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è?¬ª

–ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –≤–∞–º –Ω—É–∂–µ–Ω SCD Type 2.

–ò –ø–æ–º–Ω–∏—Ç–µ: –¥–∞–∂–µ –≤ —Å–∏—Å—Ç–µ–º–∞—Ö –±–µ–∑ `UPDATE` –≤—ã –º–æ–∂–µ—Ç–µ —Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–ª–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é ‚Äî –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å, –∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Å –ø–æ–º–æ—â—å—é –æ–∫–æ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –≥—Ä–∞–Ω–∏—Ü.

--- 

–ì–æ—Ç–æ–≤–æ! –°—Ç–∞—Ç—å—è —Ç–µ–ø–µ—Ä—å –≤–∫–ª—é—á–∞–µ—Ç –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª: –æ—Ç –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ ‚Äî –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–æ–π –°–£–ë–î ‚Äî –∏ –¥–∞–ª–µ–µ –∫ –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –¥–ª—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º.